# 数论分块

数论分块被用于快速计算含有除法向下取整的和式，类似如下表达式：
$$
\sum\limits_{i=1}^nf(i)g(\lfloor\frac{n}{i}\rfloor)
$$
如果我们可以 $O(1)$ 的求出 $\sum\limits_{i=l}^rf(i)$ 的值（不管是公式推导还是前缀和维护），那么我们就可以 $O(\sqrt{n})$ 的计算出这个表达式的值（这个 n 是指后面那个整数式子里面的 n）。

之所以能够压缩到根号复杂度，是因为 $\lfloor\frac{n}{i}\rfloor$ 的本质数量不超过 $O(2\sqrt{n})$，证明如下：

1. $i<\sqrt{n}$ 时，$\lfloor\frac{n}{i}\rfloor$ 的不同值一共只有至多 $\sqrt{n}$ 种
2. $i>\sqrt{n}$ 时，$1\leq \lfloor\frac{n}{i}\rfloor<\sqrt{n}$ ，因此也只有至多 $\sqrt{n}$ 种

接下来，我们需要依次求出这些值，并分别得到他们的对应区间。

接下来给定一个引理：若 $\lfloor\dfrac{n}{i}\rfloor=k$，那么最大的满足 $\lfloor\dfrac{n}{j}\rfloor=k$ 的 $j$ 的值为 $\lfloor\dfrac{n}{k}\rfloor$。可以直接用，不过最好看一下证明：

已知 $k=\lfloor\dfrac{n}{i}\rfloor\leq\dfrac{n}{i}$，故 $\lfloor\dfrac{n}{k}\rfloor\geq \lfloor\dfrac{n}{\frac{n}{i}}\rfloor=\lfloor i\rfloor=i$，因此 $j$ 的取值不可能超过 $\lfloor\dfrac{n}{k}\rfloor$。

那么，根据上面的证明，我们就可以来快速求解表达式了（仅作展示，实际用的时候记得开 long long，还有取模啥的）：

```cpp
int f[N], g[N], s[N];
void init() {
    for (int i = 1; i < N; ++i)
        s[i] = s[i - 1] + f[i];
}
//对于上面那种里外都是n的，不需要取min
//但是内外不一样的时候就要了
int solve(int n) {
    int res = 0;
    for (int l = 1, r; l <= n; l = r + 1) {
        r = min((n / (n / l)), n);
        res += (s[r] - s[l - 1]) * g(n / l);
    }
    return res;
}
```

